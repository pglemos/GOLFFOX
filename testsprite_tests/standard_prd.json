{
  "meta": {
    "project": "GolfFox - Sistema de Gestão de Transporte Urbano",
    "date": "2025-11-04",
    "prepared_by": "Generated by TestSprite"
  },
  "product_overview": "GolfFox is a comprehensive urban transport management platform designed for bus companies, operators, drivers, and passengers. It integrates advanced real-time GPS tracking, route management, cost control, multi-tenant support, role-based access, analytics dashboards, and automated reporting to deliver an exceptional user experience across mobile and web platforms.",
  "core_goals": [
    "Provide real-time fleet tracking and route management for urban transportation companies.",
    "Enable multi-tenant support with strict data isolation and role-based access control across various user profiles.",
    "Offer comprehensive financial management including cost tracking, budgeting, and invoice reconciliation.",
    "Deliver customizable and automated reporting and analytics to optimize operational efficiency.",
    "Ensure high security with features like CSRF protection, rate limiting, and row-level security in the database.",
    "Support fully integrated mobile (Flutter) and web (Next.js) applications for all user roles."
  ],
  "key_features": [
    "Multi-profile user access including Admin, Operator, Carrier, Driver, and Passenger with dedicated dashboards and permissions.",
    "Robust Authentication system with session management, secure cookies, and CSRF protection.",
    "Admin Panel with modules for fleet management, real-time map visualization, route optimization, vehicle and driver management, company and permission settings, incident and alert handling, and financial cost control.",
    "Operator and Carrier Panels with tailored dashboards, employee management, route tracking, alerts, communications, compliance, and financial modules.",
    "Mobile app support for drivers and passengers enabling check-in, GPS navigation, and real-time bus tracking.",
    "Automated report generation and scheduling via APIs and cron jobs for timely dispatch of operational insights.",
    "Comprehensive API suite for authentication, administration, operations, cost management, reporting, analytics, and health monitoring.",
    "Multi-tenant architecture with company-user mapping and strict RLS (Row Level Security) policies to ensure data privacy.",
    "Health check, performance analytics integration, and secure logging frameworks for monitoring and maintenance."
  ],
  "user_flow_summary": [
    "User logs in via secure login API validating credentials against Supabase users and roles stored in the database.",
    "Upon successful login, session cookies are set and user is routed to the appropriate panel based on their role (admin, operator, carrier, driver, passenger).",
    "Admins use the Admin Panel to manage companies, operators, vehicles, routes, drivers, permissions, incidents, alerts, costs, and to generate or schedule reports.",
    "Operators and Carriers access their dedicated dashboards to manage employees, routes, alerts, and financial data pertinent to their company.",
    "Drivers use the mobile app for check-in/out, GPS navigation, and trip history, while passengers can track buses in real-time and receive notifications.",
    "Automated cron jobs run to refresh KPIs, update cost reports, and dispatch scheduled reports by email.",
    "Users can request CSRF tokens for secure API interactions and have their permissions verified via middleware protecting routes based on role.",
    "Audit logs and health checks provide system integrity and operational awareness for administrators."
  ],
  "validation_criteria": [
    "Successful authentication flow with correct role-based redirection and session management via secure cookies.",
    "Access control enforced by middleware and database row level security ensuring users only access authorized data.",
    "All CRUD operations on vehicles, drivers, routes, companies, and employees function correctly with proper validations and error handling.",
    "Real-time GPS tracking and map visualizations accurately reflect current fleet locations and historical playback.",
    "Report generation APIs produce correctly formatted reports (PDF, Excel, CSV) and support scheduling and automated email dispatch.",
    "Cost management features provide accurate budgeting, manual cost entry, reconciliation, import/export, and KPI tracking.",
    "CSRF protection tokens are validated and required in state-changing API requests to prevent cross-site request forgeries.",
    "System health check endpoints return accurate status confirming connectivity with Supabase and overall application health.",
    "Comprehensive logging captures relevant actions and errors with appropriate data sanitization for security and debugging.",
    "Automated tests cover authentication, middleware, APIs, and user flows to maintain system reliability and prevent regressions."
  ],
  "code_summary": {
    "tech_stack": [
      "TypeScript",
      "Next.js 15",
      "React 18",
      "Tailwind CSS",
      "PostgreSQL",
      "Supabase",
      "Google Maps API",
      "Node.js",
      "Vercel"
    ],
    "features": [
      {
        "name": "Authentication API",
        "description": "Sistema de autenticação com login, logout, CSRF protection e gerenciamento de sessão",
        "files": [
          "web-app/app/api/auth/login/route.ts",
          "web-app/app/api/auth/csrf/route.ts",
          "web-app/app/api/auth/set-session/route.ts",
          "web-app/app/api/auth/clear-session/route.ts",
          "web-app/app/api/auth/seed-admin/route.ts"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Authentication API",
            "version": "1.0.0",
            "description": "APIs para autenticação de usuários"
          },
          "paths": {
            "/api/auth/login": {
              "post": {
                "summary": "Login de usuário",
                "requestBody": {
                  "required": true,
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "properties": {
                          "email": {
                            "type": "string",
                            "format": "email"
                          },
                          "password": {
                            "type": "string"
                          }
                        },
                        "required": [
                          "email",
                          "password"
                        ]
                      }
                    }
                  }
                },
                "responses": {
                  "200": {
                    "description": "Login bem-sucedido",
                    "content": {
                      "application/json": {
                        "schema": {
                          "type": "object",
                          "properties": {
                            "token": {
                              "type": "string"
                            },
                            "user": {
                              "type": "object"
                            }
                          }
                        }
                      }
                    }
                  },
                  "401": {
                    "description": "Credenciais inválidas"
                  }
                }
              }
            },
            "/api/auth/csrf": {
              "get": {
                "summary": "Obter token CSRF",
                "responses": {
                  "200": {
                    "description": "Token CSRF gerado",
                    "content": {
                      "application/json": {
                        "schema": {
                          "type": "object",
                          "properties": {
                            "csrfToken": {
                              "type": "string"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Admin API",
        "description": "APIs para gerenciamento administrativo: criação de operadores, veículos, rotas, empresas",
        "files": [
          "web-app/app/api/admin/create-operator/route.ts",
          "web-app/app/api/admin/vehicles/[vehicleId]/route.ts",
          "web-app/app/api/admin/generate-stops/route.ts",
          "web-app/app/api/admin/optimize-route/route.ts",
          "web-app/app/api/admin/audit-db/route.ts"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Admin API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/admin/create-operator": {
              "post": {
                "summary": "Criar operador e empresa",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "requestBody": {
                  "required": true,
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "properties": {
                          "companyName": {
                            "type": "string"
                          },
                          "operatorEmail": {
                            "type": "string",
                            "format": "email"
                          },
                          "operatorPhone": {
                            "type": "string"
                          }
                        },
                        "required": [
                          "companyName",
                          "operatorEmail"
                        ]
                      }
                    }
                  }
                },
                "responses": {
                  "201": {
                    "description": "Operador criado com sucesso"
                  },
                  "400": {
                    "description": "Dados inválidos"
                  },
                  "401": {
                    "description": "Não autorizado"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Operator API",
        "description": "APIs para operadores: criação de funcionários, otimização de rotas, associação de empresas",
        "files": [
          "web-app/app/api/operator/create-employee/route.ts",
          "web-app/app/api/operator/optimize-route/route.ts",
          "web-app/app/api/operator/associate-company/route.ts"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Operator API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/operator/create-employee": {
              "post": {
                "summary": "Criar funcionário",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "requestBody": {
                  "required": true,
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "properties": {
                          "email": {
                            "type": "string",
                            "format": "email"
                          },
                          "name": {
                            "type": "string"
                          },
                          "phone": {
                            "type": "string"
                          },
                          "role": {
                            "type": "string",
                            "enum": [
                              "passenger",
                              "driver"
                            ]
                          }
                        },
                        "required": [
                          "email",
                          "name"
                        ]
                      }
                    }
                  }
                },
                "responses": {
                  "201": {
                    "description": "Funcionário criado"
                  },
                  "400": {
                    "description": "Dados inválidos"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Costs API",
        "description": "APIs para gestão de custos: orçamentos, categorias, KPIs, reconciliação, import/export",
        "files": [
          "web-app/app/api/costs/budgets/route.ts",
          "web-app/app/api/costs/categories/route.ts",
          "web-app/app/api/costs/kpis/route.ts",
          "web-app/app/api/costs/reconcile/route.ts",
          "web-app/app/api/costs/manual/route.ts",
          "web-app/app/api/costs/import/route.ts",
          "web-app/app/api/costs/export/route.ts",
          "web-app/app/api/costs/vs-budget/route.ts"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Costs API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/costs/budgets": {
              "get": {
                "summary": "Listar orçamentos",
                "responses": {
                  "200": {
                    "description": "Lista de orçamentos",
                    "content": {
                      "application/json": {
                        "schema": {
                          "type": "array",
                          "items": {
                            "type": "object"
                          }
                        }
                      }
                    }
                  }
                }
              },
              "post": {
                "summary": "Criar orçamento",
                "requestBody": {
                  "required": true,
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "properties": {
                          "name": {
                            "type": "string"
                          },
                          "amount": {
                            "type": "number"
                          },
                          "period": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  }
                },
                "responses": {
                  "201": {
                    "description": "Orçamento criado"
                  }
                }
              }
            },
            "/api/costs/kpis": {
              "get": {
                "summary": "Obter KPIs de custos",
                "responses": {
                  "200": {
                    "description": "KPIs de custos",
                    "content": {
                      "application/json": {
                        "schema": {
                          "type": "object",
                          "properties": {
                            "totalCosts": {
                              "type": "number"
                            },
                            "budget": {
                              "type": "number"
                            },
                            "variance": {
                              "type": "number"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Reports API",
        "description": "APIs para geração e agendamento de relatórios",
        "files": [
          "web-app/app/api/reports/run/route.ts",
          "web-app/app/api/reports/schedule/route.ts",
          "web-app/app/api/reports/dispatch/route.ts"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Reports API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/reports/run": {
              "post": {
                "summary": "Executar relatório",
                "requestBody": {
                  "required": true,
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "properties": {
                          "reportType": {
                            "type": "string"
                          },
                          "format": {
                            "type": "string",
                            "enum": [
                              "pdf",
                              "excel",
                              "csv"
                            ]
                          },
                          "filters": {
                            "type": "object"
                          }
                        }
                      }
                    }
                  }
                },
                "responses": {
                  "200": {
                    "description": "Relatório gerado"
                  }
                }
              }
            },
            "/api/reports/schedule": {
              "post": {
                "summary": "Agendar relatório",
                "requestBody": {
                  "required": true,
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "properties": {
                          "reportType": {
                            "type": "string"
                          },
                          "schedule": {
                            "type": "string"
                          },
                          "recipients": {
                            "type": "array",
                            "items": {
                              "type": "string"
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "responses": {
                  "201": {
                    "description": "Relatório agendado"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Cron Jobs API",
        "description": "APIs para jobs agendados: atualização de KPIs, refresh de custos, dispatch de relatórios",
        "files": [
          "web-app/app/api/cron/refresh-kpis/route.ts",
          "web-app/app/api/cron/refresh-costs-mv/route.ts",
          "web-app/app/api/cron/dispatch-reports/route.ts"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Cron Jobs API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/cron/refresh-kpis": {
              "get": {
                "summary": "Atualizar KPIs",
                "responses": {
                  "200": {
                    "description": "KPIs atualizados"
                  }
                }
              }
            },
            "/api/cron/dispatch-reports": {
              "get": {
                "summary": "Despachar relatórios agendados",
                "responses": {
                  "200": {
                    "description": "Relatórios despachados"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Health Check API",
        "description": "API para verificação de saúde da aplicação e conexão com Supabase",
        "files": [
          "web-app/app/api/health/route.ts"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Health Check API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/health": {
              "get": {
                "summary": "Health check",
                "responses": {
                  "200": {
                    "description": "Aplicação saudável",
                    "content": {
                      "application/json": {
                        "schema": {
                          "type": "object",
                          "properties": {
                            "ok": {
                              "type": "boolean"
                            },
                            "supabase": {
                              "type": "string",
                              "enum": [
                                "ok",
                                "error"
                              ]
                            },
                            "ts": {
                              "type": "string",
                              "format": "date-time"
                            }
                          }
                        }
                      }
                    }
                  },
                  "500": {
                    "description": "Aplicação com problemas"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Analytics API",
        "description": "API para coleta de métricas de performance (Web Vitals)",
        "files": [
          "web-app/app/api/analytics/web-vitals/route.ts"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Analytics API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/analytics/web-vitals": {
              "post": {
                "summary": "Enviar métricas Web Vitals",
                "requestBody": {
                  "required": true,
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "properties": {
                          "name": {
                            "type": "string"
                          },
                          "value": {
                            "type": "number"
                          },
                          "id": {
                            "type": "string"
                          },
                          "delta": {
                            "type": "number"
                          }
                        }
                      }
                    }
                  }
                },
                "responses": {
                  "200": {
                    "description": "Métrica registrada"
                  }
                }
              }
            }
          }
        }
      }
    ]
  }
}
